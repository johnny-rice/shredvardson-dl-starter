---
title: "Use --argjson for JSON Values in jq, Not --arg"
date: 2025-10-21
category: shell-scripting
tags: [jq, json, bash, data-types]
severity: critical
---

## Problem

Using `--arg` for JSON values wraps them as **strings**, breaking the structure:

```bash
# ❌ BUG: JSON becomes a string
PR_CHECKS='[{"name":"test","status":"failed"}]'
jq -n --arg checks "$PR_CHECKS" '{
  checks_status: $checks
}'
# Output: {"checks_status": "[{\"name\":\"test\",\"status\":\"failed\"}]"}
#                            ^ STRING, not array!
```

Downstream consumers expecting an array will fail:
```javascript
// JavaScript: Cannot iterate
data.checks_status.forEach(check => ...) // ❌ TypeError: not iterable
```

## Solution

Use `--argjson` to preserve JSON structure:

```bash
# ✅ CORRECT: JSON structure preserved
PR_CHECKS='[{"name":"test","status":"failed"}]'
jq -n --argjson checks "$PR_CHECKS" '{
  checks_status: $checks
}'
# Output: {"checks_status": [{"name":"test","status":"failed"}]}
#                            ^ ARRAY, properly structured!
```

## When to Use Each

| Flag | Use For | Example |
|------|---------|---------|
| `--arg` | Plain strings | `--arg name "John"` |
| `--argjson` | JSON values (arrays, objects, booleans, numbers) | `--argjson items "$JSON_ARRAY"` |
| `--argjson` | Boolean literals | `--argjson flag true` |
| `--argjson` | Numeric values | `--argjson count 42` |

## Detection Pattern

Look for variables containing JSON being passed with `--arg`:
```bash
# Bad patterns
--arg items "$JSON_ARRAY"
--arg data "$(curl api.com)"
--arg config "$CONFIG_JSON"

# Should be
--argjson items "$JSON_ARRAY"
--argjson data "$(curl api.com)"
--argjson config "$CONFIG_JSON"
```

## Why This Matters

- **Type safety**: Consumers expect proper types (arrays, objects)
- **Silent failures**: No error thrown, just wrong data type
- **API contracts**: JSON APIs expect structured data, not strings
- **Iteration**: Can't iterate over string-wrapped arrays

## Real-World Impact

In Skills architecture, this bug meant:
- LLM receives `checks_status` as string, not array
- Cannot iterate over individual checks
- Cannot extract specific check failures
- Downstream parsing becomes error-prone

## Complete Example

```bash
#!/bin/bash
# Prepare structured data
CHECKS='[
  {"name":"test","conclusion":"failure"},
  {"name":"lint","conclusion":"success"}
]'
FILES='["src/app.ts","tests/app.test.ts"]'
COUNT=5

# ✅ Mix --arg and --argjson correctly
jq -n \
  --arg pr_number "123" \
  --argjson checks "$CHECKS" \
  --argjson files "$FILES" \
  --argjson count "$COUNT" \
  '{
    pr: $pr_number,
    checks: $checks,
    files: $files,
    count: $count
  }'

# Output (properly structured):
# {
#   "pr": "123",
#   "checks": [{"name":"test","conclusion":"failure"}, ...],
#   "files": ["src/app.ts", "tests/app.test.ts"],
#   "count": 5
# }
```

## Files Fixed

- `scripts/skills/git/pr-fix.sh:48`

## References

- [jq Manual: Invoking jq](https://jqlang.github.io/jq/manual/#invoking-jq)
- [jq Manual: --arg and --argjson](https://jqlang.github.io/jq/manual/#invoking-jq)
