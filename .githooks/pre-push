#!/bin/bash

# Pre-push hook to block direct pushes to main branch and run tests
# This script prevents accidental direct pushes to main and ensures code quality

protected_branch='refs/heads/main'

# Check for --no-verify bypass
if [ "$SKIP_HOOKS" = "true" ]; then
    echo "‚ö†Ô∏è  Bypassing pre-push hooks (SKIP_HOOKS=true)"
    exit 0
fi

# Read the input from stdin (remote name and URL)
while read local_ref local_sha remote_ref remote_sha
do
    if [ "$remote_ref" = "$protected_branch" ]; then
        echo ""
        echo "‚ùå PUSH BLOCKED: Direct pushes to 'main' branch are not allowed!"
        echo ""
        echo "üîÑ To contribute to this repository:"
        echo "   1. Create a feature branch:"
        echo "      git checkout -b feature/your-feature-name"
        echo ""
        echo "   2. Push your feature branch:"
        echo "      git push origin feature/your-feature-name"
        echo ""
        echo "   3. Create a Pull Request on GitHub"
        echo ""
        echo "üí° This workflow ensures proper code review and maintains repository quality."
        echo ""
        exit 1
    fi
done

# 1. Check lockfile sync (fast: ~0.5s)
# Check if package.json changed compared to origin/main (works for new branches)
if git diff --name-only origin/main...HEAD 2>/dev/null | grep -q "package.json"; then
    echo "üì¶ Checking lockfile sync..."
    if ! pnpm install --frozen-lockfile; then
        echo ""
        echo "‚ùå pnpm-lock.yaml is out of sync with package.json"
        echo ""
        echo "üí° Fix: Run 'pnpm install' to update the lockfile"
        echo ""
        echo "üí° To bypass this check (not recommended):"
        echo "   git push --no-verify"
        echo ""
        exit 1
    fi
    echo "‚úÖ Lockfile is in sync"
fi

# 2. TypeScript type checking (~8-12s, often cached by Turbo)
echo "üîé Type checking..."
START_TIME=$(date +%s)
TYPECHECK_OUTPUT=$(pnpm typecheck 2>&1)
TYPECHECK_EXIT=$?
echo "$TYPECHECK_OUTPUT" | grep -v "Tasks:"
if [ $TYPECHECK_EXIT -ne 0 ]; then
    echo ""
    echo "‚ùå TypeScript errors found!"
    echo ""
    echo "üí° Fix: Run 'pnpm typecheck' to see errors"
    echo ""
    echo "üí° To bypass this check (not recommended):"
    echo "   git push --no-verify"
    echo ""
    exit 1
fi
END_TIME=$(date +%s)
TYPECHECK_DURATION=$((END_TIME - START_TIME))
if [ $TYPECHECK_DURATION -lt 3 ]; then
    echo "‚úÖ Type check passed (${TYPECHECK_DURATION}s - cached)"
else
    echo "‚úÖ Type check passed (${TYPECHECK_DURATION}s)"
fi

# 3. Linting (~3-5s)
echo "‚ú® Linting..."
START_TIME=$(date +%s)
LINT_OUTPUT=$(pnpm lint 2>&1)
LINT_EXIT=$?
echo "$LINT_OUTPUT" | grep -v "Tasks:"
if [ $LINT_EXIT -ne 0 ]; then
    echo ""
    echo "‚ùå Lint errors found!"
    echo ""
    echo "üí° Fix: Run 'pnpm lint' to see errors, or 'pnpm format' to auto-fix"
    echo ""
    echo "üí° To bypass this check (not recommended):"
    echo "   git push --no-verify"
    echo ""
    exit 1
fi
END_TIME=$(date +%s)
LINT_DURATION=$((END_TIME - START_TIME))
echo "‚úÖ Lint check passed (${LINT_DURATION}s)"

# 4. Run CI script tests (fast: <2s)
echo "üîß Running CI script tests..."
if ! pnpm --silent test:ci-scripts; then
    echo ""
    echo "‚ùå CI script tests failed! Fix the scripts before pushing."
    echo ""
    echo "üí° To bypass this check (not recommended):"
    echo "   git push --no-verify"
    echo ""
    exit 1
fi
echo "‚úÖ CI scripts validated"

# 5. Run unit tests (target: <20s for optimal DX)
echo "üß™ Running unit tests..."
START_TIME=$(date +%s)

# Run tests with Turbo's affected files detection for speed
if ! pnpm --silent test:unit; then
    echo ""
    echo "‚ùå Unit tests failed! Fix the tests before pushing."
    echo ""
    echo "üí° To bypass this check (not recommended):"
    echo "   git push --no-verify"
    echo ""
    exit 1
fi

END_TIME=$(date +%s)
TEST_DURATION=$((END_TIME - START_TIME))

# Provide feedback on execution time
if [ $TEST_DURATION -lt 5 ]; then
    echo "‚úÖ All tests passed! (${TEST_DURATION}s - cached)"
elif [ $TEST_DURATION -lt 15 ]; then
    echo "‚úÖ All tests passed! (${TEST_DURATION}s)"
elif [ $TEST_DURATION -lt 30 ]; then
    echo "‚úÖ All tests passed! (${TEST_DURATION}s - acceptable)"
else
    echo "‚ö†Ô∏è  Tests passed but took ${TEST_DURATION}s (target: <20s)"
    echo "üí° Consider running fewer tests in pre-push or relying on CI for full suite"
fi

echo ""
echo "üéâ All quality checks passed!"
echo ""

exit 0