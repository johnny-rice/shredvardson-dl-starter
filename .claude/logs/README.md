# Confidence Recommendation Audit Logs

This directory contains audit logs for confidence-based recommendations in the Socratic planning workflow (`/spec:plan` command).

## Log File Format

**File:** `recommendations.jsonl` (JSON Lines format)

Each line is a complete JSON object representing one recommendation decision.

### Schema

```typescript
{
  timestamp: string;           // ISO 8601 format (e.g., "2025-01-02T10:30:00.000Z")
  sessionId: string;           // Planning session identifier
  featureName: string;         // Feature being planned (from spec title)
  confidence: number;          // Confidence percentage (0-100)
  confidenceLevel: string;     // 'HIGH' | 'MEDIUM' | 'LOW'
  recommended: string;         // Recommended option (e.g., "Option B")
  userChoice: string;          // Option user selected
  accepted: boolean;           // true if userChoice === recommended
  researchTriggered: boolean;  // true if auto-research ran
  techStack: string[];         // Detected tech stack (from package.json + ADRs)
  reasoning: string;           // Reasoning for recommendation (truncated to 100 chars)
}
```

### Example Entry

```json
{"timestamp":"2025-01-02T10:30:45.123Z","sessionId":"session_1735816245123_a4d3e7","featureName":"Add user authentication","confidence":92,"confidenceLevel":"HIGH","recommended":"Option B","userChoice":"Option B","accepted":true,"researchTriggered":false,"techStack":["Next.js","Supabase","Tailwind CSS"],"reasoning":"Based on your Next.js, Supabase, Vercel stack, this approach minimizes infrastructure changes..."}
```

## Analyzing Logs

### Quick Analysis

Run the analysis script to view metrics:

```bash
bash scripts/analyze-recommendations.sh
```

**Output:**

- Total recommendations count
- Acceptance rate (% of users who chose recommended option)
- Research trigger rate (% where auto-research was triggered)
- Average confidence for accepted vs rejected recommendations

### Manual Analysis with grep

```bash
# Count total recommendations
wc -l < .claude/logs/recommendations.jsonl

# Count accepted recommendations
grep -c '"accepted":true' .claude/logs/recommendations.jsonl

# Count research triggers
grep -c '"researchTriggered":true' .claude/logs/recommendations.jsonl

# Find recommendations for a specific feature
grep '"featureName":"user authentication"' .claude/logs/recommendations.jsonl

# Find low confidence recommendations
grep '"confidenceLevel":"LOW"' .claude/logs/recommendations.jsonl

# Extract confidence values only
grep -o '"confidence":[0-9]*' .claude/logs/recommendations.jsonl | cut -d':' -f2
```

### Analysis with jq (if installed)

```bash
# Pretty-print most recent entry
tail -n 1 .claude/logs/recommendations.jsonl | jq .

# Average confidence across all recommendations
jq -s 'map(.confidence) | add / length' .claude/logs/recommendations.jsonl

# Group by tech stack
jq -s 'group_by(.techStack | sort | join(","))' .claude/logs/recommendations.jsonl

# Filter high confidence accepted recommendations
jq 'select(.confidence >= 90 and .accepted == true)' .claude/logs/recommendations.jsonl
```

## Success Metrics

After 2 weeks of usage, review metrics:

### Target Metrics

- **Acceptance rate:** â‰¥70% (indicates good calibration)
- **Research trigger rate:** ~30% (indicates appropriate 90% threshold)
- **Average confidence (accepted):** >90%
- **Average confidence (rejected):** <85%

### Calibration Adjustments

If metrics are off target:

**Low acceptance rate (<70%):**

- Review confidence scoring algorithm in `.claude/scripts/orchestrator/confidence/calculate-confidence.ts`
- Increase weight on tech stack match (currently 30 pts)
- Decrease weight on research depth if over-relying on Research Agent findings

**High research trigger rate (>50%):**

- Raise confidence threshold from 90% to 92-95%
- Adjust scoring to be less conservative

**Low research trigger rate (<20%):**

- Lower confidence threshold from 90% to 85-88%
- Adjust scoring to be more conservative for emerging tech

## Privacy & Security

### What's Logged

- Feature names, options, and tech stack (public data from specs)
- Confidence scores and reasoning (generated by system)
- User choices (which option was selected)

### What's NOT Logged

- Personal Identifiable Information (PII)
- API keys, credentials, or secrets
- Full spec content or user prompts
- File paths beyond tech stack detection

### Log Rotation

Logs are append-only and grow over time. Consider rotating logs periodically:

```bash
# Archive logs older than 90 days
find .claude/logs -name "recommendations.jsonl" -mtime +90 -exec gzip {} \;

# Or manually archive
mv .claude/logs/recommendations.jsonl .claude/logs/recommendations-$(date +%Y-%m).jsonl
touch .claude/logs/recommendations.jsonl
```

## Troubleshooting

### Log file doesn't exist

- Run `/spec:plan` on a spec-driven feature to generate recommendations
- Check that `.claude/logs/` directory exists
- Verify confidence utilities are imported correctly

### No entries in log file

- Confidence feature only applies to Phase 2 (Exploration) of `/spec:plan`
- Only applies to `lane: spec-driven` features (not simple lane)
- Check console for logging errors

### Duplicate entries

- Each `/spec:plan` session should generate one log entry per Phase 2
- If seeing duplicates, check that `logRecommendation()` is called only once per user choice

## Related Files

- **Confidence utilities:** `.claude/scripts/orchestrator/confidence/`
- **Analysis script:** `scripts/analyze-recommendations.sh`
- **Command integration:** `.claude/commands/spec/plan.md`
- **Skill documentation:** `.claude/skills/prd-analyzer/SKILL.md`
- **Task breakdown:** `tasks/263-socratic-planning-confidence-levels.md`

## References

- **Spec:** [specs/263-socratic-planning-confidence-levels.md](../../specs/263-socratic-planning-confidence-levels.md)
- **Plan:** [plans/263-socratic-planning-confidence-levels.md](../../plans/263-socratic-planning-confidence-levels.md)
- **Issue:** #263
