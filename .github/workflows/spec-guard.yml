name: Spec Guard

on:
  pull_request:
    paths:
      - 'specs/**'
      - '.claude/commands/spec/**'
      - 'docs/constitution.md'
      - '.github/workflows/spec-guard.yml'
  push:
    branches: [main]
    paths:
      - 'specs/**'
      - '.github/workflows/spec-guard.yml'

permissions:
  contents: read
  actions: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate-spec-structure:
    name: Validate Spec Structure
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: '--no-deprecation'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.0
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate Spec Directory Structure
        run: ./scripts/ci/validate-specs.sh

      - name: Surface Spec Validation Failure
        if: failure()
        run: |
          echo "::error::Spec validation failed. See .github/DEBUGGING.md#spec-validation"
          exit 1

      - name: Upload Spec Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: spec-guard-report
          path: spec-report.md
          retention-days: 30
          if-no-files-found: ignore

  validate-spec-lane-compliance:
    name: Validate Spec Lane Compliance
    runs-on: ubuntu-latest
    needs: validate-spec-structure
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Check Spec Development Lane
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          HEAD_REF: ${{ github.head_ref }}
        run: |
          echo "Checking spec development lane compliance..."

          # Determine if this is an AI-generated PR
          is_ai_branch=false
          if [[ "$HEAD_REF" =~ ^bots/claude/ ]]; then
            is_ai_branch=true
            echo "AI-generated branch detected: $HEAD_REF"
          fi

          # Check for spec changes
          spec_changes=$(git diff --name-only origin/main...HEAD | grep "^specs/" || true)

          if [ -n "$spec_changes" ]; then
            echo "Spec changes detected:"
            echo "$spec_changes"

            if [ "$is_ai_branch" = true ]; then
              # AI branch creating/modifying specs - validate lane compliance
              echo "Validating AI lane compliance for spec changes..."

              # Check if proper issue is linked
              if [ -z "$PR_BODY" ] || ! echo "$PR_BODY" | grep -Ei "closes|fixes|resolves"; then
                echo "⚠️ Warning: AI spec changes should reference an issue"
              fi

              # Check for human oversight indicators
              if ! echo "$PR_TITLE" | grep -q "\[AI\]"; then
                echo "⚠️ Warning: AI spec changes should be clearly labeled"
              fi

              echo "✅ AI lane compliance validated for spec changes"
            else
              echo "✅ Human lane spec changes - standard validation applies"
            fi
          else
            echo "✅ No spec changes detected"
          fi
