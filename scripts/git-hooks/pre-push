#!/bin/bash

# Pre-push hook to block direct pushes to main branch and run tests
# This script prevents accidental direct pushes to main and ensures code quality

protected_branch='refs/heads/main'
current_branch=$(git symbolic-ref HEAD 2>/dev/null)

# Check for --no-verify bypass
if [ "$SKIP_HOOKS" = "true" ]; then
    echo "‚ö†Ô∏è  Bypassing pre-push hooks (SKIP_HOOKS=true)"
    exit 0
fi

# Read the input from stdin (remote name and URL)
while read local_ref local_sha remote_ref remote_sha
do
    if [ "$remote_ref" = "$protected_branch" ]; then
        echo ""
        echo "‚ùå PUSH BLOCKED: Direct pushes to 'main' branch are not allowed!"
        echo ""
        echo "üîÑ To contribute to this repository:"
        echo "   1. Create a feature branch:"
        echo "      git checkout -b feature/your-feature-name"
        echo ""
        echo "   2. Push your feature branch:"
        echo "      git push origin feature/your-feature-name"
        echo ""
        echo "   3. Create a Pull Request on GitHub"
        echo ""
        echo "üí° This workflow ensures proper code review and maintains repository quality."
        echo ""
        exit 1
    fi
done

# Run unit tests (target: <20s for optimal DX)
echo "üß™ Running unit tests..."
START_TIME=$(date +%s)

# Run tests with Turbo's affected files detection for speed
if ! pnpm --silent test:unit; then
    echo ""
    echo "‚ùå Unit tests failed! Fix the tests before pushing."
    echo ""
    echo "üí° To bypass this check (not recommended):"
    echo "   git push --no-verify"
    echo ""
    exit 1
fi

END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

# Provide feedback on execution time
if [ $DURATION -lt 5 ]; then
    echo "‚úÖ All tests passed! (${DURATION}s - cached)"
elif [ $DURATION -lt 15 ]; then
    echo "‚úÖ All tests passed! (${DURATION}s)"
elif [ $DURATION -lt 30 ]; then
    echo "‚úÖ All tests passed! (${DURATION}s - acceptable)"
else
    echo "‚ö†Ô∏è  Tests passed but took ${DURATION}s (target: <20s)"
    echo "üí° Consider running fewer tests in pre-push or relying on CI for full suite"
fi

exit 0